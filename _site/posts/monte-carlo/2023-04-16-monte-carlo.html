<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Eunki Chung">
<meta name="dcterms.date" content="2023-04-16">

<title>Eunki Chung - Importance Sampling and Black Magic of Monte Carlo</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../assets/favicon/favicon-32x32.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand navbar-dark ">
      <div class="navbar-container container-fluid">
          <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html" rel="" target="">
 <span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://linkedin.com/in/eunki-chung" rel="" target=""><i class="bi bi-linkedin" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
          <div class="quarto-navbar-tools">
</div>
            <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Importance Sampling and Black Magic of Monte Carlo</h1>
            <p class="subtitle lead">Notes on Importance Sampling and Exponential Smoothing</p>
                                <div class="quarto-categories">
                <div class="quarto-category">mathematics</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Eunki Chung </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">April 16, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="monte-carlo-method" class="level1">
<h1>Monte Carlo method</h1>
<p>The Monte Carlo method is a computational method that approximates the target value by repetitive random sampling. The goal of the method is to evaluate a function <span class="math inline">\(g(X)\)</span> where <span class="math inline">\(X\)</span> is some random quantity. One naive approach is generating random samples, <span class="math inline">\(X_1, X_2, ... X_n\)</span>, from computer simulation using pseudo-random number generation, and taking the average of evaluated <span class="math inline">\(g(X_i)\)</span>. That is, <span class="math display">\[
E[g(X)] \approx \frac{1}{n} \sum_{i=1}^{n} g(X_i)
\]</span> This is called the direct sampling method and is indeed powerful in many settings. However, it has a severe shortcoming when the function is related to the occurrence of rare events. Let’s assume we have a standard normal random variable <span class="math inline">\(X\sim N(0, 1)\)</span> and want to evaluate a function <span class="math inline">\(g(X) = \mathbb{1}(X &gt; 30)\)</span>. Note that <span class="math inline">\(E[\mathbb{1}(X &gt; 30)] = P(X &gt; 30)\)</span> so we know that the analytical solution of this problem is not zero. And also, notice that the direct estimation is essentially just counting the number of samples greater than 30 and calculating the frequency of that event.</p>
<p>Fortunately, we can easily generate standard normal samples using the Box-Muller algorithm, but it is almost impossible to get a sample greater than 30. Our direct MC estimate will indicate 0 until we get a single observation greater than 30, which will require a tremendous amount of samples unless we are very lucky. Even if we observe a desired sample with a meager chance, the variance of the estimation, hence the efficiency of the method, would still be poor.</p>
</section>
<section id="importance-sampling" class="level1">
<h1>Importance Sampling</h1>
<section id="univariate-case" class="level2">
<h2 class="anchored" data-anchor-id="univariate-case">Univariate case</h2>
<p>One way to address this issue is using the Importance Sampling method. With the following simple algebra, we can convert the estimation to one that is amazingly more efficient than the direct method. <span class="math display">\[
\begin{aligned}
E[g(X)] &amp;= \int_{-\infty}^{\infty} g(x)f_X(x)dx \\
&amp;= \int_{-\infty}^{\infty} g(x) \frac{1}{\sqrt{2\pi}}\exp\left(-\frac{x^2}{2}\right)dx \\
&amp;= \int_{-\infty}^{\infty} g(x) \frac{1}{\sqrt{2\pi}}\exp\left(-\frac{x^2}{2}+\mu x -\frac{\mu^2}{2} -\mu x + \frac{\mu^2}{2}\right)dx \\
&amp;= \int_{-\infty}^{\infty} g(x) \frac{1}{\sqrt{2\pi}}\exp\left(-\frac{(x - \mu)^2}{2} -\mu x + \frac{\mu^2}{2}\right)dx \\
&amp;= \int_{-\infty}^{\infty} g(x) \frac{1}{\sqrt{2\pi}}\exp\left(-\frac{(x - \mu)^2}{2}\right) \exp\left( -\mu x + \frac{\mu^2}{2}\right)dx \\
&amp;= \int_{-\infty}^{\infty} g(x) \exp\left( -\mu x + \frac{\mu^2}{2}\right) f_{X'}(x) dx \quad \text{where } X' \sim N(\mu, 1)\\
&amp;= E\left[g(X') \exp\left( -\mu X' + \frac{\mu^2}{2}\right)\right]\\
&amp;\approx \frac{1}{n}\sum_{i=1}^n\left\{g(x'_i)\exp\left(-\mu x'_i + \frac{\mu^2}{2}\right)\right\}
\end{aligned}
\]</span> Here, we’re sampling from a shifted normal variable <span class="math inline">\(X'\)</span>, evaluate <span class="math inline">\(g\)</span> with samples <span class="math inline">\(x_i'\)</span> and do a correction by multiplying <span class="math inline">\(\exp\left(-\mu x'_i + \frac{\mu^2}{2}\right)\)</span> to retrieve the original target value. If we choose a <span class="math inline">\(\mu = 30\)</span>, we can easily sample <span class="math inline">\(x'&gt;30\)</span> and this significantly improves the quality of the Monte Carlo estimate.</p>
</section>
<section id="exponential-smoothing" class="level2">
<h2 class="anchored" data-anchor-id="exponential-smoothing">Exponential Smoothing</h2>
<p>It turns out that there is a direct analog of this approach for the Multivariate case and even for the stochastic process, called Exponential Smoothing. For example, let’s consider the following Brownian Motion(BM) with drift. <span class="math display">\[
X_t = B_t + \mu t \quad t \geq 0
\]</span> and we have discrete time points s.t. <span class="math inline">\(0=t_0 &lt; t_1&lt; \cdots &lt; t_n = T\)</span>.</p>
<p>Similar to the Univariate case, our objective is to evaluate the expectation, <span class="math inline">\(E[f(X_{t_1}, X_{t_2}, \dots, X_{t_n})]\)</span>, where <span class="math inline">\(f: \mathbb{R}^n \rightarrow \mathbb{R}\)</span> is a bounded Borel function. Notice that since <span class="math inline">\(B_t\)</span> is BM, <span class="math inline">\(X_t\)</span> has independent increments. Let <span class="math inline">\(x_0 = 0\)</span>, and <span class="math inline">\(g: \mathbb{R}^n \rightarrow \mathbb{R}\)</span> s.t. <span class="math inline">\(f(x_1, x_2, \dots, x_n) = g(x_1 - x_0, x_2-x_1, \cdots, x_n - x_{n-1})\)</span> Because of the independent increments, the joint density is a product of the marginal probability of the increments <span class="math inline">\(X_i - X_{i-1}\)</span>, which is given by. <span class="math display">\[
\begin{aligned}
X_i - X_{i-1} &amp;= B_{t_i} + \mu t_i - B_{t_{i-1}} - \mu t_{i-1} \\
&amp;= B_{t_i} - B_{t_{i-1}} + \mu (t_i - t_{i-1}) \\
\end{aligned}
\]</span> Since <span class="math inline">\(B_{t_i} - B_{t_{i-1}} \sim N(0,\ t_i - t_{i-1})\)</span>, <span class="math inline">\(X_i - X_{i-1} \sim N(\mu(t_i - t_{i-1}),\ t_i - t_{i-1})\)</span>. Then the joint pdf is given by, <span class="math display">\[
\prod_{i=1}^n \frac{1}{\sqrt{2\pi}\sqrt{t_i - t_{i-1}}} \exp\left(- \frac{((x_i - x_{i-1}) - \mu(t_i - t_{i-1}))^2}{2(t_i - t_{i-1})}\right)
\]</span> We can separate the constant term of <span class="math display">\[
C = (2\pi) ^{-n/2}\cdot \left( t_1-t_{0}\right) ^{-1/2}\cdot \left( t_{2}-t_{1}\right) ^{-1/2} \ldots \left( t_{n}-t_{n-1}\right) ^{-1/2}
\]</span> and the remaining exponent part, <span class="math display">\[
\begin{aligned}
&amp; \prod_{i=1}^n \exp\left(- \frac{((x_i - x_{i-1}) - \mu(t_i - t_{i-1}))^2}{2(t_i - t_{i-1})}\right)\\
=&amp; \prod_{i=1}^n \exp\left(- \frac{(x_i - x_{i-1})^2 -2(x_i - x_{i-1})\mu(t_i - t_{i-1}) + \mu^2(t_i - t_{i-1})^2}{2(t_i - t_{i-1})}\right) \\
=&amp; \prod_{i=1}^n \exp\left(- \frac{(x_i - x_{i-1})^2}{2(t_i - t_{i-1})}  +(x_i - x_{i-1})\mu - \frac{\mu^2}{2}(t_i - t_{i-1})\right) \\
=&amp; \prod_{i=1}^n \exp\left(- \frac{(x_i - x_{i-1})^2}{2(t_i - t_{i-1})}\right) \exp\left((x_i - x_{i-1})\mu - \frac{\mu^2}{2}(t_i - t_{i-1})\right) \\
=&amp; \prod_{i=1}^n \exp\left(- \frac{(x_i - x_{i-1})^2}{2(t_i - t_{i-1})}\right) \prod_{i=1}^n \exp\left((x_i - x_{i-1})\mu - \frac{\mu^2}{2}(t_i - t_{i-1})\right) \\
=&amp; \left\{\prod_{i=1}^n \exp\left(- \frac{(x_i - x_{i-1})^2}{2(t_i - t_{i-1})}\right)\right\} \exp\left(\sum_{i=1}^n(x_i - x_{i-1})\mu - \frac{\mu^2}{2}(t_i - t_{i-1})\right) \\
=&amp; \left\{\prod_{i=1}^n \exp\left(- \frac{(x_i - x_{i-1})^2}{2(t_i - t_{i-1})}\right)\right\} \exp\left(\mu\sum_{i=1}^n (x_i - x_{i-1}) - \frac{\mu^2}{2} \sum_{i=1}^n (t_i-t_{i-1})\right) \\
=&amp; \left\{\prod_{i=1}^n \exp\left(- \frac{(x_i - x_{i-1})^2}{2(t_i - t_{i-1})}\right)\right\} \exp\left(\mu x_n - \frac{1}{2}\mu^2 t_n\right)
\end{aligned}
\]</span></p>
<p>Note that $C _{i=1}^n (- )$ is the joint density of <span class="math inline">\((B_{t_1}- B_{t_0}, \ B_{t_2}- B_{t_1}, \cdots,\ B_{t_n}-B_{t_{n-1}})\)</span>. Then we can convert the original expectation as follows.</p>
<p><span class="math display">\[
E[f(X_{t_1}, X_{t_2}, \dots, X_{t_n})] = E\left[f(B_{t_1}, B_{t_2}, \dots, B_{t_n}) \exp\left(\mu B_T - \frac{1}{2}\mu^2 T\right)\right]
\]</span></p>
<p>As in the Univariate case, we have converted the expection with respect to <span class="math inline">\(B_t\)</span> instead of <span class="math inline">\(X_t\)</span>, evaluate <span class="math inline">\(f(\cdot)\)</span>, then do a correction by multiplying <span class="math inline">\(\exp\left(\mu B_T - \frac{1}{2}\mu^2 T\right)\)</span>. One interesting fact is that the correction term <span class="math inline">\(M_t = \exp\left(\mu B_t - \frac{1}{2}\mu^2 t\right)\)</span> is a martingale. <span class="math display">\[
\newcommand{\indep}{\perp \!\!\! \perp}
\begin{aligned}
E[M_t|\mathcal{F_s}] &amp;= E\left[\exp\left(\left.\mu B_t - \frac{1}{2}\mu^2 t\right)\right|\mathcal{F_s}\right] \\
&amp;= E\left[\exp\left(\left.\mu B_t - \mu B_s + \mu B_s - \frac{1}{2}\mu^2 (t-s) - \frac{1}{2}\mu^2 s \right)\right|\mathcal{F_s}\right] \\
&amp;= E\left[\exp\left(\mu B_s - \frac{1}{2}\mu^2 s\right) \exp\left(\left.\mu (B_t - B_s) - \frac{1}{2}\mu^2 (t-s)  \right)\right|\mathcal{F_s}\right] \\
&amp;= M_s E\left[\exp\left(\mu (B_t - B_s) - \frac{1}{2}\mu^2 (t-s)  \right)\right] \quad \because\ B_t - B_s \indep \mathcal{F_s} \\
&amp;= M_s E\left[\exp\left(\mu (B_t - B_s)\right) \exp\left(- \frac{1}{2}\mu^2 (t-s)  \right)\right] \\
&amp;= M_s \exp\left(- \frac{1}{2}\mu^2 (t-s)  \right) E\left[\exp\left(\mu Y\right) \right] \quad \text{where } Y\sim N(0,\ t-s) \\
\\
\text{Notice }&amp;E\left[\exp\left(\mu Y\right) \right] \text{ is the MGF of }Y \\
\\
&amp;= M_s \exp\left(- \frac{1}{2}\mu^2 (t-s) \right) \exp\left(\frac{1}{2}\mu^2 (t-s) \right)  \\
&amp;= M_s
\end{aligned}
\]</span></p>
</section>
</section>
<section id="change-of-measure" class="level1">
<h1>Change of measure</h1>
<p>In the previous example, while we were deriving the joint pdf of the process, we only did algebra and used some trivial properties of BM. Surprisingly, however, we ended up having the martingale correction term <span class="math inline">\(M_t\)</span>. It further turns out that <span class="math inline">\(M_t\)</span> coincides with the Radon-Nikodym derivative we get if we apply Girsanov’s theorem to the same problem.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>